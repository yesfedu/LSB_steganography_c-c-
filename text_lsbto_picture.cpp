                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
#include "text_lsbto_picture.h"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
#include "common.h"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
// Function to read a file (txt, docx, pdf) and return its content as a string                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
std::string fileToTextConverter(const std::string& inputFilePath)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    std::string extractedContent;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    std::string externalCommand;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    try {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
        std::string fileExtension = inputFilePath.substr(inputFilePath.find_last_of(".") + 1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
        if (fileExtension == "txt") 
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            std::ifstream inputFileStream(inputFilePath);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            if (!inputFileStream.is_open()) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                throw std::runtime_error("Error: Could not open TXT file for reading: " + inputFilePath);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            std::stringstream stringStream;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
            std::string line;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            while (getline(inputFileStream, line)) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                if (!line.empty() && line.back() != '\n') 
                { // Avoid double newlines                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                    stringStream << line << '\n';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                } else {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                    stringStream << line;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            inputFileStream.close();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
            extractedContent = stringStream.str(); // Efficient string construction                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        } 
        else if (fileExtension == "docx") 
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            externalCommand = "docx2txt \"" + inputFilePath + "\" -"; // Use docx2txt tool                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            FILE* externalPipe = popen(externalCommand.c_str(), "r");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            if (!externalPipe) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                throw std::runtime_error("Error: Could not execute docx2txt command (docx): " + externalCommand);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
            std::string buffer;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
            int status;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
            char tempBuffer[128];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            while (fgets(tempBuffer, sizeof(tempBuffer), externalPipe) != NULL) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                buffer += tempBuffer;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            status = pclose(externalPipe);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            if (status != 0)
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                throw std::runtime_error("Error: docx2txt returned a non-zero exit code");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
            extractedContent = buffer;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    } 
    catch (const std::exception& e) 
    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        throw std::runtime_error("Failed to extract required information from " + inputFilePath + "!  Inner exception: " + e.what());                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    return extractedContent;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
// Function to a message inside an image using LSB steganography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
bool lsbImageHider(cv::Mat& inputImage, const std::string& messageToHide)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    int imgWidth = inputImage.cols;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    int imgHeight = inputImage.rows;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    int imgChannels = inputImage.channels();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    size_t messageIndex = 0; // Current index in the message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
    int bitPlacement = 0;  // Current bit in the current character                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    for (int row = 0; row < imgHeight; ++row) 
    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        for (int col = 0; col < imgWidth; ++col) 
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            for (int channel = 0; channel < imgChannels; ++channel) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                if (messageIndex < messageToHide.length()) 
                {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                    unsigned char& pixel = inputImage.at<cv::Vec3b>(row, col)[channel];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                    char bitToSet = (messageToHide[messageIndex] >> bitPlacement) & 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                    pixel = (pixel & 0xFE) | bitToSet; // Set LSB                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                    bitPlacement++;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                    if (bitPlacement == 8) 
                    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                        bitPlacement = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                        messageIndex++;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                } 
                else 
                {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                    // Message fully embedded, set the LSB of remaining pixels to 0 to indicate end of message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                    unsigned char& pixel = inputImage.at<cv::Vec3b>(row, col)[channel];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                    pixel &= 0xFE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    return true;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
// Function to reveal a message from an image with LSB steganography                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
std::string lsbImageRevealer(const cv::Mat& inputImage) 
{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    std::string revealedMessage;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    int imgWidth = inputImage.cols;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    int imgHeight = inputImage.rows;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    int imgChannels = inputImage.channels();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    char currentCharacter = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
    int bitIndex = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    for (int row = 0; row < imgHeight; ++row) 
    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        for (int col = 0; col < imgWidth; ++col) 
        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
            for (int channel = 0; channel < imgChannels; ++channel) 
            {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                unsigned char pixel = inputImage.at<cv::Vec3b>(row, col)[channel];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                char lsb = pixel & 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                currentCharacter |= (lsb << bitIndex);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                bitIndex++;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                if (bitIndex == 8) 
                {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                    if (currentCharacter == 0) 
                    {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                        return revealedMessage; // End of message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                    revealedMessage += currentCharacter;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                    currentCharacter = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                    bitIndex = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
    return revealedMessage;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
}  